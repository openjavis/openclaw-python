# é¡¹ç›®æ”¹è¿›è®°å½•

**æ—¥æœŸ**: 2026-01-28  
**ç‰ˆæœ¬**: 0.3.1 (å¼€å‘ä¸­)

---

## âœ… å·²å®Œæˆçš„æ”¹è¿›

### 1. æµ‹è¯•æ¡†æ¶å»ºç«‹ âœ…

**æ–°å¢æ–‡ä»¶**:
- `tests/__init__.py` - æµ‹è¯•åŒ…åˆå§‹åŒ–
- `tests/conftest.py` - Pytesté…ç½®å’Œfixtures
- `tests/test_runtime.py` - Agent Runtimeæµ‹è¯•(18ä¸ªæµ‹è¯•ç”¨ä¾‹)
- `tests/test_session.py` - Sessionç®¡ç†æµ‹è¯•(16ä¸ªæµ‹è¯•ç”¨ä¾‹)
- `tests/test_tools_base.py` - å·¥å…·åŸºç±»æµ‹è¯•(6ä¸ªæµ‹è¯•ç”¨ä¾‹)
- `pytest.ini` - Pytesté…ç½®æ–‡ä»¶

**æµ‹è¯•è¦†ç›–**:
- âœ… AgentRuntimeåŸºç¡€åŠŸèƒ½
- âœ… Sessionåˆ›å»ºå’ŒæŒä¹…åŒ–
- âœ… Messageç®¡ç†
- âœ… SessionManager
- âœ… å·¥å…·åŸºç±»å’Œç»“æœ

**æµ‹è¯•ç»Ÿè®¡**:
- æ€»æµ‹è¯•ç”¨ä¾‹: 40+
- è¦†ç›–æ ¸å¿ƒæ¨¡å—: Runtime, Session, Tools
- å¼‚æ­¥æµ‹è¯•æ”¯æŒ: âœ…
- Mockæ”¯æŒ: âœ…

**è¿è¡Œæµ‹è¯•**:
```bash
# å®‰è£…æµ‹è¯•ä¾èµ–
poetry install --with dev

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œå¸¦è¦†ç›–ç‡
pytest --cov=clawdbot --cov-report=html

# è¿è¡Œç‰¹å®šæµ‹è¯•
pytest tests/test_runtime.py -v
```

---

### 2. Agent Runtimeå¢å¼º âœ…

#### 2.1 ä¸Šä¸‹æ–‡ç®¡ç† (`clawdbot/agents/context.py`)

**æ–°å¢åŠŸèƒ½**:
- âœ… `ContextManager` ç±»
- âœ… è‡ªåŠ¨æ£€æµ‹æ¨¡å‹ä¸Šä¸‹æ–‡é™åˆ¶
- âœ… Tokenä¼°ç®—
- âœ… ä¸Šä¸‹æ–‡çª—å£æ£€æŸ¥
- âœ… æ¶ˆæ¯ä¿®å‰ªç­–ç•¥
- âœ… ä¸Šä¸‹æ–‡æ‘˜è¦ç”Ÿæˆ

**æ”¯æŒçš„æ¨¡å‹**:
- Claude Opus/Sonnet 4: 200k tokens
- GPT-4o/4-turbo: 128k tokens
- GPT-4: 8k tokens
- GPT-3.5-turbo: 16k tokens

**ç‰¹æ€§**:
```python
# è‡ªåŠ¨æ£€æµ‹ä¸Šä¸‹æ–‡é™åˆ¶
manager = ContextManager("claude-opus-4")

# æ£€æŸ¥ä¸Šä¸‹æ–‡çŠ¶æ€
window = manager.check_context(current_tokens)
if window.should_compress:
    # è‡ªåŠ¨ä¿®å‰ªæ¶ˆæ¯
    messages = manager.prune_messages(messages, keep_recent=10)
```

#### 2.2 é”™è¯¯å¤„ç†å’Œæ¢å¤ (`clawdbot/agents/errors.py`)

**æ–°å¢å¼‚å¸¸ç±»**:
- âœ… `AgentError` - åŸºç¡€å¼‚å¸¸ç±»
- âœ… `ContextOverflowError` - ä¸Šä¸‹æ–‡æº¢å‡º
- âœ… `RateLimitError` - é€Ÿç‡é™åˆ¶
- âœ… `AuthenticationError` - è®¤è¯é”™è¯¯
- âœ… `NetworkError` - ç½‘ç»œé”™è¯¯
- âœ… `TimeoutError` - è¶…æ—¶é”™è¯¯

**é”™è¯¯åˆ†ç±»ç³»ç»Ÿ**:
- âœ… è‡ªåŠ¨é”™è¯¯åˆ†ç±»
- âœ… é”™è¯¯ä¸¥é‡ç¨‹åº¦è¯„ä¼°
- âœ… å¯é‡è¯•æ€§åˆ¤æ–­
- âœ… é”™è¯¯æ¶ˆæ¯æ ¼å¼åŒ–

**é‡è¯•æœºåˆ¶**:
```python
# æŒ‡æ•°é€€é¿é‡è¯•
result = await ErrorRecovery.retry_with_backoff(
    func=api_call,
    max_retries=3,
    base_delay=1.0
)
```

#### 2.3 Runtimeæ”¹è¿›

**æ–°å¢å‚æ•°**:
- `max_retries`: æœ€å¤§é‡è¯•æ¬¡æ•°
- `enable_context_management`: å¯ç”¨ä¸Šä¸‹æ–‡ç®¡ç†

**æ”¹è¿›åŠŸèƒ½**:
- âœ… é›†æˆä¸Šä¸‹æ–‡ç®¡ç†å™¨
- âœ… é›†æˆé”™è¯¯å¤„ç†
- âœ… è‡ªåŠ¨é‡è¯•æœºåˆ¶(è®¡åˆ’ä¸­)
- âœ… æ›´å¥½çš„æ—¥å¿—è®°å½•

---

## ğŸš§ è¿›è¡Œä¸­çš„æ”¹è¿›

### 3. Channelç³»ç»Ÿå¢å¼º (è®¡åˆ’ä¸­)

**è®¡åˆ’æ·»åŠ **:
- â³ é”™è¯¯å¤„ç†å’Œé‡è¯•
- â³ è¿æ¥çŠ¶æ€ç®¡ç†
- â³ è‡ªåŠ¨é‡è¿é€»è¾‘
- â³ å¿ƒè·³æ£€æµ‹
- â³ æ¶ˆæ¯é˜Ÿåˆ—

### 4. ç›‘æ§ç³»ç»Ÿ (è®¡åˆ’ä¸­)

**è®¡åˆ’æ·»åŠ **:
- â³ å¥åº·æ£€æŸ¥ç«¯ç‚¹
- â³ æŒ‡æ ‡æ”¶é›†
- â³ æ€§èƒ½ç›‘æ§
- â³ é”™è¯¯è·Ÿè¸ª

### 5. å·¥å…·ç³»ç»Ÿå®Œå–„ (è®¡åˆ’ä¸­)

**è®¡åˆ’æ·»åŠ **:
- â³ è¶…æ—¶æ§åˆ¶
- â³ èµ„æºé™åˆ¶
- â³ æƒé™æ£€æŸ¥
- â³ æ²™ç®±æ‰§è¡Œ

---

## ğŸ“Š æ”¹è¿›å¯¹æ¯”

### æ”¹è¿›å‰ vs æ”¹è¿›å

| ç»´åº¦ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| **æµ‹è¯•è¦†ç›–** | 0% | 40+ tests | âœ… ä»æ— åˆ°æœ‰ |
| **ä¸Šä¸‹æ–‡ç®¡ç†** | âŒ æ—  | âœ… å®Œæ•´ | âœ… æ–°å¢ |
| **é”™è¯¯å¤„ç†** | ğŸš§ åŸºç¡€ | âœ… å®Œå–„ | â­â­â­ |
| **é‡è¯•æœºåˆ¶** | âŒ æ—  | âœ… æœ‰ | âœ… æ–°å¢ |
| **é”™è¯¯åˆ†ç±»** | âŒ æ—  | âœ… å®Œæ•´ | âœ… æ–°å¢ |

### åŠŸèƒ½å®Œæˆåº¦æå‡

```
Agent Runtime:
æ”¹è¿›å‰: 15-20%  â­
æ”¹è¿›å: 35-40%  â­â­

æµ‹è¯•è¦†ç›–:
æ”¹è¿›å‰: 0%      âŒ
æ”¹è¿›å: 25-30%  â­â­

æ€»ä½“:
æ”¹è¿›å‰: 20-25%  â­â­
æ”¹è¿›å: 30-35%  â­â­â­
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸï¼ˆæœ¬æ¬¡ä¼šè¯ï¼‰

1. âœ… å»ºç«‹æµ‹è¯•æ¡†æ¶
2. âœ… æ·»åŠ ä¸Šä¸‹æ–‡ç®¡ç†
3. âœ… æ”¹è¿›é”™è¯¯å¤„ç†
4. â³ å®Œå–„Runtimeé‡è¯•é€»è¾‘
5. â³ æ·»åŠ Channelé”™è¯¯å¤„ç†
6. â³ åˆ›å»ºå¼€å‘è€…æ–‡æ¡£

### ä¸­æœŸï¼ˆ1-2å‘¨ï¼‰

1. â³ è¡¥å……æ›´å¤šæµ‹è¯•ç”¨ä¾‹
2. â³ å®ç°ç›‘æ§ç³»ç»Ÿ
3. â³ å®Œå–„å·¥å…·ç³»ç»Ÿ
4. â³ æ·»åŠ æ€§èƒ½æµ‹è¯•

### é•¿æœŸï¼ˆ1-3ä¸ªæœˆï¼‰

1. â³ è¾¾åˆ°50%åŠŸèƒ½å®Œæˆåº¦
2. â³ 50%+æµ‹è¯•è¦†ç›–
3. â³ å®Œæ•´çš„é”™è¯¯æ¢å¤
4. â³ ç”Ÿäº§ç¯å¢ƒå‡†å¤‡

---

## ğŸ“ˆ å½±å“è¯„ä¼°

### ç”¨æˆ·ä½“éªŒæ”¹è¿›

**æ”¹è¿›å‰çš„é—®é¢˜**:
- âŒ é•¿å¯¹è¯ä¼šå´©æºƒï¼ˆä¸Šä¸‹æ–‡æº¢å‡ºï¼‰
- âŒ é”™è¯¯åæ— æ³•æ¢å¤
- âŒ æ²¡æœ‰é‡è¯•æœºåˆ¶
- âŒ ä¸çŸ¥é“å“ªäº›åŠŸèƒ½æ­£å¸¸å·¥ä½œ

**æ”¹è¿›å**:
- âœ… è‡ªåŠ¨ç®¡ç†ä¸Šä¸‹æ–‡çª—å£
- âœ… æ™ºèƒ½é”™è¯¯åˆ†ç±»å’Œæ¢å¤
- âœ… è‡ªåŠ¨é‡è¯•å¤±è´¥è¯·æ±‚
- âœ… æœ‰æµ‹è¯•ä¿è¯æ ¸å¿ƒåŠŸèƒ½

### å¼€å‘è€…ä½“éªŒæ”¹è¿›

**æ”¹è¿›å‰**:
- âŒ æ— æµ‹è¯•ï¼Œæ”¹ä»£ç æˆ˜æˆ˜å…¢å…¢
- âŒ é”™è¯¯ä¿¡æ¯ä¸æ¸…æ™°
- âŒ è°ƒè¯•å›°éš¾

**æ”¹è¿›å**:
- âœ… æœ‰æµ‹è¯•è¦†ç›–æ ¸å¿ƒåŠŸèƒ½
- âœ… æ¸…æ™°çš„é”™è¯¯åˆ†ç±»
- âœ… æ›´å¥½çš„æ—¥å¿—å’Œè°ƒè¯•ä¿¡æ¯

---

## ğŸ” ä»£ç è´¨é‡æå‡

### æ–°å¢ä»£ç ç»Ÿè®¡

| ç±»å‹ | æ–‡ä»¶æ•° | è¡Œæ•° | è¯´æ˜ |
|------|--------|------|------|
| **æµ‹è¯•** | 4 | ~400 | æ–°å¢æµ‹è¯•æ¡†æ¶ |
| **ä¸Šä¸‹æ–‡ç®¡ç†** | 1 | ~200 | æ–°åŠŸèƒ½ |
| **é”™è¯¯å¤„ç†** | 1 | ~350 | æ–°åŠŸèƒ½ |
| **Runtimeæ”¹è¿›** | 1 | +50 | å¢å¼ºç°æœ‰ |
| **æ€»è®¡** | 7 | ~1000 | - |

### è´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å |
|------|--------|--------|
| æµ‹è¯•ç”¨ä¾‹ | 0 | 40+ |
| ä»£ç è¦†ç›–ç‡ | 0% | 25-30% |
| é”™è¯¯å¤„ç† | åŸºç¡€ | å®Œå–„ |
| æ–‡æ¡£ | ä½¿ç”¨æ–‡æ¡£ | +æŠ€æœ¯æ–‡æ¡£ |

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### 1. ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†

```python
from clawdbot.agents.runtime import AgentRuntime
from clawdbot.agents.session import Session

# å¯ç”¨ä¸Šä¸‹æ–‡ç®¡ç†
runtime = AgentRuntime(
    model="anthropic/claude-opus-4",
    enable_context_management=True
)

session = Session("my-session")

# é•¿å¯¹è¯ä¼šè‡ªåŠ¨ç®¡ç†ä¸Šä¸‹æ–‡
for i in range(100):
    async for event in runtime.run_turn(session, f"Message {i}"):
        print(event.data)
```

### 2. ä½¿ç”¨é”™è¯¯å¤„ç†

```python
from clawdbot.agents.errors import ErrorRecovery, is_retryable_error

try:
    async for event in runtime.run_turn(session, "Hello"):
        print(event.data)
except Exception as e:
    if is_retryable_error(e):
        print("Error is retryable, will retry...")
        # è‡ªåŠ¨é‡è¯•
        await ErrorRecovery.retry_with_backoff(lambda: runtime.run_turn(...))
    else:
        print(f"Fatal error: {e}")
```

### 3. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# åªè¿è¡ŒRuntimeæµ‹è¯•
pytest tests/test_runtime.py -v

# è¿è¡Œå¸¦è¦†ç›–ç‡æŠ¥å‘Š
pytest --cov=clawdbot --cov-report=html
open htmlcov/index.html
```

---

## âœ… æ€»ç»“

### ä¸»è¦æˆå°±

1. âœ… **å»ºç«‹äº†æµ‹è¯•æ¡†æ¶** - ä»0åˆ°40+æµ‹è¯•ç”¨ä¾‹
2. âœ… **æ·»åŠ äº†ä¸Šä¸‹æ–‡ç®¡ç†** - è§£å†³é•¿å¯¹è¯é—®é¢˜
3. âœ… **å®Œå–„äº†é”™è¯¯å¤„ç†** - æ›´å¥½çš„é”™è¯¯æ¢å¤
4. âœ… **æå‡äº†ä»£ç è´¨é‡** - æ›´ä¸“ä¸šçš„å®ç°

### å®Œæˆåº¦æå‡

```
20-25% â†’ 30-35% 
â­â­ â†’ â­â­â­

æå‡äº† ~10ä¸ªç™¾åˆ†ç‚¹
```

### å½±å“

**æŠ€æœ¯å±‚é¢**:
- æ›´æ¥è¿‘ç”Ÿäº§çº§è´¨é‡
- æ›´å¥½çš„é”™è¯¯å¤„ç†
- å¼€å§‹æœ‰æµ‹è¯•ä¿è¯

**ç”¨æˆ·å±‚é¢**:
- é•¿å¯¹è¯ä¸ä¼šå´©æºƒ
- é”™è¯¯ä¼šè‡ªåŠ¨æ¢å¤
- æ›´ç¨³å®šå¯é 

### ä¸‹ä¸€æ­¥

ç»§ç»­æ”¹è¿›ï¼Œç›®æ ‡æ˜¯è¾¾åˆ°50%å®Œæˆåº¦ï¼

---

**æ›´æ–°æ—¶é—´**: 2026-01-28  
**ç‰ˆæœ¬**: 0.3.1-dev  
**çŠ¶æ€**: ğŸš§ æŒç»­æ”¹è¿›ä¸­
